let Product,multer,path,CustomErrorHandler,Joi,fs;_997‍.x([["default",()=>_997‍.o]]);_997‍.w("../models",[["Product",["Product"],function(v){Product=v}]]);_997‍.w("multer",[["default",["multer"],function(v){multer=v}]]);_997‍.w("path",[["default",["path"],function(v){path=v}]]);_997‍.w("../services/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_997‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_997‍.w("fs",[["default",["fs"],function(v){fs=v}]]);






const storage = multer.diskStorage({
    destination:(req,file,cb)=>cb(null,'uploads'),
    filename :(req,file,cb)=>{
        const uniqueName = `${Date.now()}-${Math.round(Math.random()*1E9)}${path.extname(file.originalname)}`;
        cb(null,uniqueName)
    }
})

const handleMultipartData = multer({storage,limits:{fileSize: 1000000*5}}).single('image');  //fileSize:5MB


const productController = {

    async store(req, res, next){

        //multi part form data
        handleMultipartData(req, res, async (err)=>{

            _997‍.g.console.log(req.body)

            if(err){
                return next(CustomErrorHandler.serverError(err.message));
            }

            const filePath = req.file.path;

            //validation
            const productSchema = Joi.object({
                name:Joi.string().required(),
                price:Joi.number().required(),
                size:Joi.string().required(),
            })

            const {error} = productSchema.validate(req.body);
            if(error){
                //Delete the uploaded pic
                fs.unlink(`${appRoot}/${filePath}`, (err)=>{
                    return next(CustomErrorHandler.serverError(err.message))
                })
                return next(error);
            }
            
            const {name, price, size} = req.body;
            
            let document;
            try {
                document = await Product.create({
                    name,
                    price,
                    size,
                    image:filePath,
                });
            } catch (error) {
               return next(err); 
            }

            res.status(201).json({});
        })

        
    }
} 


_997‍.d(productController);